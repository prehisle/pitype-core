# 测试指南

本文档介绍 pitype-core 项目的测试体系、如何运行测试以及测试覆盖率情况。

## 测试框架

- **单元测试**: [Vitest](https://vitest.dev/) - 快速的 Vite 原生测试框架
- **E2E 测试**: [Playwright](https://playwright.dev/) - 端到端浏览器测试
- **覆盖率工具**: V8 coverage provider

## 测试结构

```
packages/pitype-core/
├── tests/                    # 单元测试
│   ├── *.spec.ts            # 核心模块测试
│   └── dom/                 # DOM 相关测试
│       └── *.spec.ts
└── src/                      # 源代码
    ├── *.ts                 # 核心模块
    └── dom/                 # DOM 适配器
        └── *.ts

tests/                        # E2E 测试
└── baseline/
    └── typerank3.spec.ts    # 基准测试
```

## 快速开始

### 运行所有测试

```bash
npm test
```

这会依次运行基准测试和单元测试。

### 只运行单元测试

```bash
npm run test:unit
```

### 生成覆盖率报告

```bash
npm run test:unit -- --coverage
```

执行后会在 `coverage/` 目录生成 HTML 报告，在浏览器中打开 `coverage/index.html` 查看详细信息。

### 运行 E2E 测试

```bash
npm run test:baseline
```

## 开发时测试

### 监听模式

在开发过程中，可以使用监听模式自动运行相关测试：

```bash
npx vitest
```

文件改动时会自动重新运行受影响的测试。

### 运行特定测试

```bash
# 运行单个测试文件
npx vitest packages/pitype-core/tests/recorder.spec.ts

# 运行匹配模式的测试
npx vitest player

# 只运行失败的测试
npx vitest --run --reporter=verbose --bail
```

### UI 模式

Vitest 提供了可视化测试界面：

```bash
npx vitest --ui
```

## 测试覆盖率

### 当前覆盖率状态

**核心模块 (`packages/pitype-core/src`)**：

| 指标 | 覆盖率 | 目标 | 状态 |
|------|--------|------|------|
| 语句 (Statements) | 88.96% | 80% | ✅ |
| 分支 (Branches) | 82.86% | 70% | ✅ |
| 函数 (Functions) | 88.5% | 80% | ✅ |
| 行 (Lines) | 88.96% | 80% | ✅ |

### 模块覆盖率明细

| 模块 | 语句 | 分支 | 函数 | 说明 |
|------|------|------|------|------|
| index.ts | 100% | 100% | 100% | 入口文件 |
| locale.ts | 92% | 75% | 75% | 语言支持 |
| tokenizer.ts | 97.77% | 92.85% | 100% | 文本分词 |
| statsTracker.ts | 91.04% | 85.18% | 100% | 统计追踪 |
| typingSession.ts | 88.65% | 73.33% | 90.9% | 会话管理 |
| sessionRuntime.ts | 81.95% | 71.73% | 80% | 运行时 |
| textSource.ts | 100% | 100% | 100% | 文本源 |
| recorder.ts | ~85% | ~80% | ~85% | 录制功能 |
| player.ts | ~85% | ~80% | ~85% | 回放功能 |
| ghostManager.ts | ~60% | ~70% | ~65% | 幽灵管理 |
| **DOM 模块** |
| statsPanel.ts | 100% | 82.35% | 100% | 统计面板 |
| themeController.ts | 93.06% | 79.48% | 92.3% | 主题控制 |
| textRenderer.ts | 88.46% | 72.34% | 90% | 文本渲染 |
| inputController.ts | 77.77% | 61.53% | 66.66% | 输入控制 |
| cursorAdapter.ts | ~75% | ~65% | ~75% | 光标适配 |

### 查看详细报告

```bash
# 生成覆盖率报告
npm run test:unit -- --coverage

# 在浏览器中打开
# macOS
open coverage/index.html

# Linux
xdg-open coverage/index.html

# Windows
start coverage/index.html
```

## 测试套件

### 单元测试

#### 核心功能测试

- `tokenizer.spec.ts` (5 tests) - 文本分词和标记化
- `textSource.spec.ts` (3 tests) - 文本源管理
- `typingSession.spec.ts` (7 tests) - 打字会话核心逻辑
- `sessionRuntime.spec.ts` (3 tests) - 会话运行时
- `locale.spec.ts` (3 tests) - 多语言支持

#### 录制与回放测试

- `recorder.spec.ts` (17 tests) - 录制功能
  - 基本录制功能（开始、停止、状态）
  - 录制选项（自定义 ID、元数据）
  - 序列化和反序列化
  - 文件导入导出
- `player.spec.ts` (24 tests) - 回放功能
  - 播放控制（播放、暂停、停止、恢复）
  - 速度控制
  - 跳转功能
  - 事件回调
  - 统计信息
- `ghostManager.spec.ts` (15 tests) - 幽灵对战管理
  - 幽灵添加、移除、查询
  - 外观配置（颜色、形状、透明度）
  - 批量控制
  - 资源清理

#### DOM 适配器测试

- `cursorAdapter.spec.ts` (16 tests) - 光标适配器
  - 位置更新和动画
  - 外观配置（形状、颜色、闪烁）
  - 响应式支持
  - 移动端支持
- `textRenderer.spec.ts` (4 tests) - 文本渲染
- `statsPanel.spec.ts` (3 tests) - 统计面板
- `themeController.spec.ts` (3 tests) - 主题控制
- `inputController.spec.ts` (3 tests) - 输入控制

### E2E 测试

- `typerank3.spec.ts` - 基准应用端到端测试

## 编写测试

### 测试文件命名

测试文件应与源文件同名，使用 `.spec.ts` 或 `.test.ts` 后缀：

```
src/recorder.ts  →  tests/recorder.spec.ts
src/dom/cursorAdapter.ts  →  tests/dom/cursorAdapter.spec.ts
```

### 基本测试结构

```typescript
import { describe, expect, it, beforeEach, vi } from 'vitest';
import { createRecorder } from '../src/recorder.js';

describe('Recorder', () => {
  let recorder;

  beforeEach(() => {
    recorder = createRecorder();
  });

  describe('基本功能', () => {
    it('应该能够开始录制', () => {
      recorder.start(session, textSource);
      expect(recorder.isRecording()).toBe(true);
    });
  });
});
```

### 模拟和测试工具

```typescript
// 模拟函数
const mockFn = vi.fn();

// 模拟时间
vi.useFakeTimers();
vi.advanceTimersByTime(1000);

// 异步测试
it('应该异步完成', async () => {
  await someAsyncOperation();
  expect(result).toBe(expected);
});
```

## CI/CD 集成

### GitHub Actions 配置示例

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm test
      - run: npm run test:unit -- --coverage
```

## 调试测试

### 使用 VS Code

在测试文件中设置断点，然后使用 VS Code 的调试配置：

```json
{
  "type": "node",
  "request": "launch",
  "name": "Debug Tests",
  "program": "${workspaceFolder}/node_modules/vitest/vitest.mjs",
  "args": ["--run"],
  "console": "integratedTerminal"
}
```

### 使用 Chrome DevTools

```bash
node --inspect-brk ./node_modules/vitest/vitest.mjs
```

然后在 Chrome 中访问 `chrome://inspect`。

## 故障排查

### 测试失败

1. 检查错误消息和堆栈跟踪
2. 使用 `--reporter=verbose` 获取详细输出
3. 在测试中添加 `console.log` 调试
4. 使用 `.only()` 隔离失败的测试

```typescript
it.only('这个测试会单独运行', () => {
  // 测试代码
});
```

### 覆盖率不足

1. 运行 `npm run test:unit -- --coverage` 生成报告
2. 在浏览器中打开 `coverage/index.html`
3. 查看未覆盖的代码行
4. 为未覆盖的分支添加测试用例

### 性能问题

```bash
# 并行运行测试（默认）
npx vitest --threads

# 禁用并行
npx vitest --no-threads

# 限制并发数
npx vitest --max-concurrency=4
```

## 最佳实践

1. **测试隔离**: 每个测试应该独立，不依赖其他测试的状态
2. **清晰命名**: 测试名称应该清楚描述被测试的功能
3. **AAA 模式**: Arrange（准备）、Act（执行）、Assert（断言）
4. **边界测试**: 测试边界条件和错误情况
5. **避免过度模拟**: 只模拟外部依赖，不模拟被测试的代码
6. **保持简单**: 每个测试只验证一个行为

## 参考资源

- [Vitest 文档](https://vitest.dev/)
- [Playwright 文档](https://playwright.dev/)
- [测试最佳实践](https://github.com/goldbergyoni/javascript-testing-best-practices)
