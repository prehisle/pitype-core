# 04 接入 @pitype-core 指南

## 安装

在目标项目中安装核心包（假设未来发布为 `pitype-core`）：

```bash
npm install pitype-core
# 或
pnpm add pitype-core
```

## 创建文本源

使用 `createTextSource` 将任意文本转换为可复用的 token 流，可附加 `id`、`locale` 或自定义 tokens：

```ts
import { createTextSource } from 'pitype-core';

const source = createTextSource('Hello world!', {
  id: 'demo-text',
  locale: 'en-US'
});
```

如有特殊分词需求，可自行生成 `TextToken[]` 并通过 `tokens` 传入。

## TypingSession 与事件

```ts
import { TypingSession } from 'pitype-core';

const session = new TypingSession({ source });

session.subscribe((event) => {
  switch (event.type) {
    case 'session:start':
      // 初始化 UI
      break;
    case 'input:evaluate':
      // 根据 event.index/event.correct 更新 DOM
      break;
    case 'input:undo':
      // 撤销状态
      break;
    case 'session:complete':
      // 展示结果
      break;
  }
});

session.input('a'); // 注入用户输入
session.undo(); // 撤销上一个字符
session.reset(); // 重新开始
```

`session.getState()` 会返回当前 text/position/entries/locale 等信息，可驱动光标或高亮逻辑。

## StatsTracker

```ts
import { createStatsTracker } from 'pitype-core';

const tracker = createStatsTracker(session);

// 建议在 UI 的定时器或事件回调中读取
const snapshot = tracker.getSnapshot();
console.log(snapshot.correctCpm, snapshot.accuracy);
```

Snapshots 包含 duration、CPM/TCPM/WPM、字符计数、准确率等指标，可直接渲染到面板。

## Locale 与多语言

若需自定义语言资源，可使用 `registerLocale` 与 `getLocaleString`（示例见 `examples/typerank3/language.js`）：

```ts
import { registerLocale, getLocaleString } from 'pitype-core';

registerLocale({
  code: 'en-US',
  strings: {
    'ui.statsLabels.cpm': 'CPM'
  }
});

console.log(getLocaleString('en-US', 'ui.statsLabels.cpm'));
```

配合 TextSource 的 `locale` 属性，可为不同文本自动绑定语言环境。

## DOM 渲染容器建议

`createDomTextRenderer` 默认会清空传入容器的所有子节点。若你的框架把输入框、光标等元素写在模板中，可以开启 `preserveChildren`，仅删除由渲染器生成的内容：

```ts
const renderer = createDomTextRenderer(textDisplay, {
  preserveChildren: true,
  textContentClass: 'text-content'
});
```

推荐结构如下，将文字与输入/光标拆成同级节点，可在 Vue/React/Svelte 中保留响应式：

```html
<div class="text-display" ref="container">
  <div class="text-content" ref="textContent"></div>
  <input ref="input" />
  <div class="cursor" ref="cursor"></div>
</div>

const renderer = createDomTextRenderer(textContent, { preserveChildren: true }); const cursorAdapter
= createDomCursorAdapter({ textDisplay: container, ... });
```

这样 `text-content` 负责渲染 token，输入与光标的生命周期仍由框架掌控。

## Demo/调试

仓库中的 `examples/typerank3` 作为参考实现，可通过以下命令体验：

```bash
npm run sync:demo   # 构建 core 并同步到 demo
npm run baseline:serve   # 启动静态服务器（http://127.0.0.1:4173）
npm run baseline:dev     # 热重载开发模式：监听 core 与 demo 目录
npm run test        # 运行 Playwright + Vitest 全量测试
npm run lint        # ESLint
npm run format      # Prettier
```

“热重载”模式会同时执行以下任务：

1. `pitype-core` 使用 `tsc --watch` 编译；保存 TypeScript 即触发增量构建。
2. 构建产物变更会自动同步到 `examples/typerank3/vendor`，无需手动运行 `sync:demo`。
3. `live-server` 监听 `examples/typerank3` 整个目录，自动刷新浏览器页面。

因此无论修改 `packages/pitype-core` 还是 demo 中的脚本/样式，浏览器都会自动重载。

Playwright baseline（`tests/baseline/typerank3.spec.ts`）展示了端到端测试的写法，可根据自身 UI 扩展类似用例。
