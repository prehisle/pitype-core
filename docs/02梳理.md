## typerank3 现状梳理

- 结构：纯 HTML/CSS/JS 单页练习器，所有状态都在 `typerank3/script.js` 全局变量中维护，直接操作 DOM（参见 `typerank3/script.js:1-200`）。
- 文本处理：`init()` 会从 `texts.js` 中抽取段落，根据中英文分别切分成 `<span>` 并绑定空格/标点，支持换行和缓存顺序（`typerank3/script.js:305-420`）。
- 实时统计：`updateStats()` 每秒计算 CPM/TCPM/WPM、准确率和字符数，配合回退修正、组合输入法检测、移动端聚焦等逻辑（`typerank3/script.js:547-850`）。
- 多语言/主题：`language.js` 提供简中/繁中/英文与五套主题的资源表，初始化时更新页面文案与提示（`typerank3/language.js:1-200`）。
- 文案与样式：练习文本硬编码在 `typerank3/texts.js:1-50`，样式集中在 `typerank3/style.css`，强调隐藏滚动条、光标动画、响应式布局。

## 可抽象的核心能力

1. **文本管线**：段落选择、语言识别、token 化（单词/汉字/标点/空格/换行）和顺序缓存，可抽象为 `TextSource + Tokenizer`。
2. **会话状态机**：`currentPosition`、`correctChars`、`totalChars`、`startTime` 及 `handleInput`/`Backspace` 行为，可封装为 `TypingSession`，通过事件暴露状态。
3. **统计引擎**：`updateStats()` 提供 CPM/TCPM/WPM/Accuracy/Duration 的纯计算逻辑，可独立成 `StatsTracker`。
4. **语言与主题资源**：`language.js` 数据可转成配置，核心暴露 `registerLocale()`、`getText()` 等 API；主题也可作为元数据供 UI 使用。
5. **文本加载接口**：`texts.js` 可演化为可插拔数据源（同步数组、异步 API、流式生成），核心仅依赖统一接口。

## 当前耦合痛点

- 逻辑依赖具体 DOM 结构（大量 `document.querySelector`），无法在其他 UI/框架中复用。
- `handleInput()` 用 `classList` 作为状态，缺少与 UI 脱钩的数据模型；其它渲染层无法接管。
- 文本、主题、语言、弹窗等写死在同一脚本，缺乏配置注入与事件系统，也没有测试/类型约束。
- 没有 npm/TS/打包脚手架，无法导出 ESM/CJS/类型声明，无法直接发布或在 Node 环境使用。

## 推进 `pitype-core` 的建议步骤

1. **拆内核**：先提炼 `TypingSession` 与 `StatsTracker`（建议 TypeScript），输入 token 列表，输出状态与事件（开始/进度/完成/错误），DOM 逻辑改为适配层。
2. **Token 管线抽象**：把 `init()` 的文本拆分逻辑移到独立模块，支持多语言策略、空格/标点绑定、换行 token，并允许注入自定义策略。
3. **资源配置化**：把 `language.js`、`texts.js` 等转为 JSON/配置，核心提供注册接口，UI 自行决定呈现方式但共享数据。
4. **包结构与构建**：在仓库内建立 `packages/pitype-core`（或根目录初始化 npm），配置 TS + Rollup/Vite 构建，导出 ESM/CJS/`.d.ts`，并添加针对 session/统计的单元测试。
5. **Demo 适配**：保留 `typerank3` 作为 demo，重写为消费 `pitype-core` 的页面，验证核心 API，同时提供示例用法。
6. **扩展点设计**：定义事件 API 与可插拔策略（文本源、语言、配色、滚动/光标策略），让其他应用能覆盖 UI 或扩展题库、排行榜等功能。
