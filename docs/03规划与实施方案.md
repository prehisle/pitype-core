# 03 规划与实施方案

## 总体目标

- 将现有 `typerank3` 页面逻辑抽象为可复用的 `pitype-core` npm 包，为不同前端/终端的打字应用提供统一的核心能力。
- 保留并升级 `typerank3` 作为演示与验收场景，验证 `pitype-core` 的 API 设计与扩展性。

## 方法论：TDD 驱动原则

- **测试先行**：每个任务先编写失败的测试（单元/集成/端到端），再实现功能，最后重构。
- **多层级保障**：核心算法用单元测试，模块间交互用集成测试，typerank3 demo 负责端到端对照测试。
- **回归可信**：所有缺陷需先复现为测试用例，再修复；CI 必须阻塞未通过的测试。
- **质量指标**：关键模块设置覆盖率阈值（如 90%+ 函数覆盖），测试命名与断言需体现业务语义。

## 当前阶段进展（2025-11-10）

- ✅ **Milestone 0**：完成 monorepo 架构、Playwright 基线测试，以及 demo 运行基准记录（`npm test` 触发端到端 + 单测）。
- ✅ **Milestone 1**：`TypingSession` + `StatsTracker` 已以 TDD 方式实装，并在 `packages/pitype-core/tests/typingSession.spec.ts` 覆盖生命周期、撤销、统计等场景。
- ✅ **Milestone 2（推进中）**：`tokenizeText` 覆盖中/英/标点/换行、全角符号、IME 全角空格，`TypingSession` 默认使用 token 序列；TextSource/Locale API 已落地并具备契约测试。
- ✅ **Milestone 3（推进中）**：TypeScript、Vitest、Playwright、ESLint、Prettier 以及 GitHub Actions CI 已接入；仍需补构建 smoke tests 与更严格的质量门槛。
- ✅ **Milestone 4（推进中）**：`examples/typerank3` 消费 `@pitype-core`，Playwright 覆盖中文多行、错误输入+撤销、主题/语言切换、移动端滚动等场景，并新增《04 接入指南》。
- ⏳ **Milestone 5**：尚未启动，需等待核心与 demo 稳定再推进。

## 里程碑拆解

### Milestone 0：仓库准备与基线验证

- **代码基线**：确认 `typerank3` 最新版本（v0.1.21）功能完整并可本地运行，记录已知问题。
- **仓库结构**：决定包管理模式（monorepo `packages/pitype-core` 或直接在根目录），预留 `examples/typerank3`。
- **需求确认**：冻结核心指标范围（CPM/TCPM/WPM、准确率、输入事件、语言/主题等），输出约束文档。
- **基准测试集**：录制/编写一组端到端脚本，捕获当前行文排版、光标移动、统计计算的期望行为，作为后续回归基线。

### Milestone 1：核心会话与统计模块

- **TypingSession 抽象**：先写覆盖开始/输入/回退/完成/错误流的单元测试，再实现纯逻辑模块，提供 `start/stop/input/undo` 等 API。
- **事件系统**：定义进度、错误、完成、重置等事件，支持订阅/取消订阅，保证 UI 可接入。
- **StatsTracker**：在实现前先写消费虚拟时间线的测试，验证 CPM/TCPM/WPM/Accuracy 计算精度，再转为独立模块。
- **质量门槛**：M1 完成时，应有自动化测试证明 session 与统计在多语言文本/快速输入/回退等场景下成立。

### Milestone 2：文本与配置管线

- **Tokenizer**：通过黄金样例（中/英/混合/IME 特殊字符）编写快照测试，再实现多策略拆分与断言。
- **TextSource 接口**：为同步、异步、流式场景编写契约测试，确保核心在不同数据来源下行为一致。
- **配置注入**：将语言/主题数据结构化（JSON/TS 类型），并通过 API 层测试验证注册/读取流程及缺省回退。
- **质量门槛**：Tokenizer/Locale 模块需要 fixture 驱动测试，保证后续新增语料不会破坏现有行为。

> 最新状态：Tokenizer 已与 TypingSession 深度整合，且覆盖全角/IME 用例；下一步需设计 TextSource/locale API。

### Milestone 3：包结构与工程化

- **TypeScript 化**：搭建 TS + ESLint + Vitest（或 Jest）基础设施，先编写典型测试用例，确保类型声明与实现同步演进。
- **构建链路**：配置 Rollup/Vite build，输出 ESM/CJS/类型声明；为打包脚本添加 smoke tests（导入/运行/Tree-shaking 验证）。
- **CI/质量**：CI 需执行 lint/test/build/coverage 任务，若任一测试失败或覆盖率跌破阈值即阻塞。

> 最新状态：TS + Vitest + Playwright + ESLint/Prettier + GitHub Actions CI 已就绪，下一步聚焦构建 smoke tests 与更细的质量门槛。

### Milestone 4：示例与适配层

- **typerank3 适配**：在改造前先写 Playwright/Cypress 等端到端测试脚本，覆盖关键流程，再切换到 core API。
- **文档与 demo**：文档示例需要配套可运行的示例测试（如 `npm run example-test`），确保说明与代码一致。
- **回归测试**：端到端脚本与 Milestone 0 的基线结果比对，若 diff 超出容忍度则阻塞上线。

> 最新状态：demo 已新增“错误输入 + 撤销” Playwright 用例；仍需覆盖主题/语言切换、移动端滚动等场景，并撰写接入指南。

### Milestone 5：扩展 & 发布

- **扩展点**：整理可插拔策略（文本源、打字规则、奖励机制、滚动策略）并提供接口示例。
- **版本发布**：发布前运行全量测试矩阵（不同 Node 版本/浏览器），CI Tag 成功后才允许 `npm publish`。
- **后续路线**：规划后续迭代（如云题库、排行榜、多人实时对战等）并登记在 roadmap。

## 任务优先级建议

1. **核心逻辑抽离（M1）**：直接决定后续所有工作，优先投入。
2. **Tokenizer & 配置（M2）**：是正确率、中文支持、UI 扩展的关键，紧跟核心拆分。
3. **工程化构建（M3）**：保障 npm 化的必要条件，可与 M2 并行推进。
4. **Demo 适配 & 文档（M4）**：用于验收与对外展示，确保核心能力可落地。
5. **扩展与发布（M5）**：在核心稳定后安排，避免过早优化。

## 依赖与风险

- **旧逻辑迁移风险**：全局变量/DOM 强耦合，拆分时需制定临时适配层，避免功能倒退。
- **文本策略复杂度**：中文、英文、混合输入及 IME 支持边界较多，Tokenizer 需大量测试。
- **工程化投入**：若当前仓库缺少 Node/TS 环境，需要额外时间搭建依赖与 CI。
- **人力分配**：若同一时间需要维护现有页面和抽象核心，需明确职责与验收标准。

## 开发辅助命令

- `npm run sync:demo`：一键构建 `pitype-core` 并将 `dist` 同步到 `examples/typerank3/vendor`，Playwright 基线（`npm run test:baseline`）会自动在执行前调用。
- `npm run build:core`：仅构建核心包（不做同步），便于在包级别验证类型与产物。
- `npm run lint`：运行 ESLint（含 Prettier 兼容规则）确保多包代码风格一致。
- `npm run format`：使用 Prettier 统一格式化常见文件类型。

## 建议的下一步

1. **M2 收尾**：在 TextSource/Locale API 基础上扩展异步文本源、多语言 fallback 的契约测试，并准备外部数据源示例。
2. **M3 加固**：补充构建 smoke tests、提高覆盖率阈值、扩展 CI（缓存 Playwright 浏览器、上传测试报告等）。
3. **M4 深化**：基于《04 接入指南》增加 UI 适配示例/FAQ，并继续扩展 Playwright（多主题截图、移动端手势互动）。
4. **自动分发后续**：在 release/CI 流程中纳入 `npm run sync:demo` 及 demo 预览构建，确保演示与 core 同步。
